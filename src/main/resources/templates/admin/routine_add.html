<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout/layout_admin">

<th:block layout:fragment="content">
	<div class="content-wrapper">
		<div class="content">

			<div class="card card-default">
				<div class="card-body">
					<form action="" method="post" name="routineForm" th:object="${routineAddDTO}">
						<div class="row">
							<!-- memberId -->
							<div class="col-lg-6">
								<div class="form-group">
									<label for="memberId">회원번호</label>
									<input type="text" class="form-control" th:field="*{memberId}">
								</div>
							</div>
							<!-- totalTime -->
							<div class="col-lg-3">
								<div class="form-group">
									<label for="totalTime">전체시간</label>
									<input type="text" class="form-control" th:field="*{totalTime}" readonly>
								</div>
							</div>
							<!-- routineActive -->
							<div class="col-lg-3">
								<div class="form-group mt-6">
									<label for="routineActive">활성화</label>
									<div th:each="err : ${#fields.errors('routineActive')}" class="error-message" th:text="${err}"></div>
									<label class="switch switch-icon switch-primary form-control-label">
										<input type="checkbox" class="switch-input form-check-input" id="switch-active" value="true" checked>
										<input type="hidden" th:field="*{routineActive}">
										<span class="switch-label"></span>
										<span class="switch-handle"></span>
									</label>
								</div>
							</div>
						</div>
						<!-- routineName -->
						<div class="form-group mb-4">
							<label for="routineName">루틴명</label>
							<div class="error-message hide" id="routineName-error">제목을 입력해주세요.</div>
							<div th:each="err : ${#fields.errors('routineName')}" class="error-message" th:text="${err}"></div>
							<input type="text" class="form-control" th:field="*{routineName}">
						</div>
						<!-- mission list -->
						<div class="form-group mb-4">
							<table class="table">
								<thead class="thead-light">
									<tr>
										<th scope="col">icon</th>
										<th scope="col">name</th>
										<th scope="col">runtime</th>
										<th scope="col">content</th>
										<th scope="col" class="text-center th-width-115">imp/del</th>
									</tr>
								</thead>
								<tbody id="missionList">
								</tbody>
								<tfoot>
									<tr>
										<td colspan="5" class="text-center">
											<button type="button" id="addButton" class="btn btn-block btn-outline-primary">미션 추가하기</button>
										</td>
									</tr>
								</tfoot>
							</table>
						</div>
						<!-- button -->
						<div class="d-flex justify-content-between mt-6">
							<button class="btn btn-outline-brown mb-2" type="button" th:onclick="|location.href='@{|/admin/board-list?boardCategory=${boardCategory}|}';|" >목록</button>
							<button class="btn btn-outline-brown mb-2" type="button" id="submitButton">완료</button>
						</div>
					</form>
				</div>
			</div>
		
		</div>
	</div>
</th:block>

<th:block layout:fragment="script">
	<script>

		$(function() {

			$('#switch-active').click(function() {
				if ($('#routineActive').val() == 'true') $('#routineActive').val('falue')
				else $('#routineActive').val('true')
			});

			$('#addButton').click(function() {

				let index = $('#missionList tr').length
				
				$('#missionList').append(
					'	<tr>' +
					'		<td><input type="text" class="form-control" id="iconId" name="iconId"></td>' +
					'		<td><input type="text" class="form-control" id="missionName" name="missionName"></td>' +
					'		<td><input type="text" class="form-control" id="runtime" name="runtime" onclick=saveTime(' + index + ') onblur="checkTime(' + index + ')" ></td>' +
					'		<td><input type="text" class="form-control" id="missionContent" name="missionContent"></td>' +
					'		<td><div class="btn-group" role="group" aria-label="Basic example">' +
					'			<button type="button" class="btn btn-sm btn-outline-primary px-2">미션</button>' +
					'			<button type="button" class="btn btn-sm btn-outline-primary px-2 removeButton">삭제</button>' +
					'		</div></td>' +
					'	</tr>'
				);
				
				$('.removeButton').on('click', function() {
					$(this).parents("tr").remove (); // remove the button
				});

				// $('.runtime').on('blur', function() {
				// 	alert('asdas')
				// 	let runtime = document.getElementsByName('runtime')
				// 	let reg = /^(0[0-9]|1[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])$/
				// 	if (!reg.test(this.value)) {
				// 		alert('asdas')
				// 	}
				// });
			});
			
			// $('#removeButton').on('click', function() {
			// 	$(this).parents("tr").remove (); // remove the button
			// });

			$('#submitButton').on('click', function() {
				// 유효성 검사
				// routineName
				if($('#routineName').val().trim() == ''){
					$('#routineName-error').css('display', 'inline-block')
					$('#routineName').val('')
					$('#routineName').focus()
					return;
				} else {
					$('#routineName-error').hide()
				}

				let iconId = document.getElementsByName('iconId')
				let missionName = document.getElementsByName('missionName')
				let runtime = document.getElementsByName('runtime')
				let missionContent = document.getElementsByName('missionContent')

				for (let i = 0; i < iconId.length; i++) {
					// 아이콘
					if (!iconId[i].value) {
						alert('아이콘 필수');
						iconId[i].focus();
						return;
					}
					// 미션명
					if (missionName[i].value.trim() == '') {
						alert('미션명 필수');
						missionName[i].value = '';
						missionName[i].focus();
						return;
					}
					// 소요시간
					if (runtime[i].value.trim() == '') {
						alert('소요시간 필수');
						runtime[i].value == '';
						runtime[i].focus();
						return;
					} else {
						let runtime = document.getElementsByName("runtime")[i].value;
						let reg = /^(0[0-9]|1[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])$/
						if (!reg.test(runtime)) {
							checkTime(i)
							runtime[i].focus();
							return;
						}
					}
				}

				document.routineForm.submit();
			});

		});
		
		function addTime(data1) {
			let time1 = new Date('1970-01-01 ' + totalTime)
			let time2 = new Date('1970-01-01 ' + data1)
			time1.setHours(time1.getHours() + time2.getHours())
			time1.setMinutes(time1.getMinutes() + time2.getMinutes())
			time1.setSeconds(time1.getSeconds() + time2.getSeconds())
			totalTime = '' + (time1.getHours() < 10 ? '0' + time1.getHours() : time1.getHours())
								+ ':' + (time1.getMinutes() < 10 ? '0' + time1.getMinutes() : time1.getMinutes())
								+ ':' + (time1.getSeconds() < 10 ? '0' + time1.getSeconds() : time1.getSeconds())
		}
		
		function subTime(data1) {
			let time1 = new Date('1970-01-01 ' + totalTime)
			let time2 = new Date('1970-01-01 ' + data1)
			time1.setHours(time1.getHours() - time2.getHours())
			time1.setMinutes(time1.getMinutes() - time2.getMinutes())
			time1.setSeconds(time1.getSeconds() - time2.getSeconds())
			totalTime = '' + (time1.getHours() < 10 ? '0' + time1.getHours() : time1.getHours())
								+ ':' + (time1.getMinutes() < 10 ? '0' + time1.getMinutes() : time1.getMinutes())
								+ ':' + (time1.getSeconds() < 10 ? '0' + time1.getSeconds() : time1.getSeconds())
		}
	
		let totalTime = '00:00:00'
		let currentTime = '00:00:00'
		function saveTime(num) {
			currentTime = '00:00:00'
			let runtime = document.getElementsByName("runtime")[num].value;
			let reg = /^(0[0-9]|1[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])$/
			if (reg.test(runtime)) {
				currentTime = runtime
			}
		}

		function checkTime(num) {
			let runtime = document.getElementsByName("runtime")[num].value;
			let reg = /^(0[0-9]|1[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])$/
			if (!reg.test(runtime)) {
				subTime(currentTime)
				console.log(totalTime)
				currentTime = '00:00:00'
				alert('시간형식에 맞게 입력해주세요(hh:mm:ss)')
			} else {
				subTime(currentTime)
				addTime(runtime)
				$('#totalTime').val(totalTime)
			}
		}

	</script>
</th:block>

</html>
